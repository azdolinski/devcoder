#!/usr/bin/with-contenv bash
# shellcheck shell=bash
source /etc/s6-overlay/s6-rc.d/echo_module.sh
set_module_name "init-devcoder-nodejs"



echo "▶️  Start installer"

export PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:$PATH"
ENV_NPM_PACKAGES=""
FILE_NPM_PACKAGES=""
NPM_PACKAGES_TO_INSTALL=""

run_as_root() {
  if [ "$(id -u)" = "0" ]; then
    "$@"
    return
  fi
  if command -v sudo >/dev/null 2>&1; then
    /usr/bin/sudo -E "$@"
    return
  fi
  if command -v su >/dev/null 2>&1; then
    su -s /bin/bash root -c "$(printf '%q ' "$@")"
    return
  fi
  "$@"
}

install_nodejs_dev_environment() {
  echo "**** installing nodejs dev environment ****"
  NODEJS_MOD_VERSION=${NODEJS_MOD_VERSION:-16}
  if [[ ! -f "/etc/apt/sources.list.d/nodesource.list" ]]; then
    run_as_root bash -c "curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor | tee /usr/share/keyrings/nodesource.gpg >/dev/null"
    run_as_root bash -c "echo 'deb [signed-by=/usr/share/keyrings/nodesource.gpg] https://deb.nodesource.com/node_${NODEJS_MOD_VERSION}.x nodistro main' > /etc/apt/sources.list.d/nodesource.list"
  fi
  if [[ ! -f "/etc/apt/sources.list.d/yarn.list" ]]; then
    run_as_root bash -c "curl -fsSL https://dl.yarnpkg.com/debian/pubkey.gpg | gpg --dearmor | tee /usr/share/keyrings/yarnsource.gpg >/dev/null"
    run_as_root bash -c "echo 'deb [signed-by=/usr/share/keyrings/yarnsource.gpg] https://dl.yarnpkg.com/debian/ stable main' > /etc/apt/sources.list.d/yarn.list"
  fi

  echo "**** Adding nodejs and yarn to package install list ****"
  cat <<'EOF' >> /devcoder-apt-nodejs.txt
nodejs
yarn
EOF
}

wait_for_npm_installer() {
  local waited=0
  while ! command -v npm >/dev/null 2>&1; do
    if (( waited >= 60 )); then
      echo "⚠️  npm not available after 60 seconds."
      return 1
    fi
    sleep 1
    ((waited++))
  done
}

install_nvm() {
  local target_home=$1
  local nvm_dir="$target_home/.nvm"
  echo "**** installing nvm ****"
  run_as_user bash -c "export HOME='$target_home'; export NVM_DIR='$nvm_dir'; if [ ! -s '$nvm_dir/nvm.sh' ]; then curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/master/install.sh | bash; echo '**** loading nvm ****'; source '$nvm_dir/nvm.sh'; echo '**** installing the latest release ****'; nvm install node; else echo '**** nvm already installed, skipping ****'; fi"
}

run_as_user() {
  if id -u "$TARGET_USER" >/dev/null 2>&1; then
    if [ "$(id -u)" = "$(id -u "$TARGET_USER")" ]; then
      "$@"
      return
    fi
    if command -v sudo >/dev/null 2>&1; then
      /usr/bin/sudo -E -u "$TARGET_USER" env PATH="$PATH" "$@"
      return
    fi
    if command -v su >/dev/null 2>&1; then
      su -s /bin/bash "$TARGET_USER" -c "$(printf '%q ' "$@")"
      return
    fi
    if command -v s6-setuidgid >/dev/null 2>&1; then
      s6-setuidgid "$TARGET_USER" "$@"
      return
    fi
  fi
  "$@"
}

if [ -n "${NPM_PACKAGES:-}" ]; then
  ENV_NPM_PACKAGES="${NPM_PACKAGES//\"/}"
  ENV_NPM_PACKAGES="${ENV_NPM_PACKAGES//,/ }"
  NPM_PACKAGES_TO_INSTALL="$NPM_PACKAGES_TO_INSTALL $ENV_NPM_PACKAGES"
fi

TARGET_USER="${CUSTOM_USER:-abc}"
if id "$TARGET_USER" >/dev/null 2>&1; then
  TARGET_UID=$(id -u "$TARGET_USER")
  TARGET_GID=$(id -g "$TARGET_USER")
  TARGET_HOME=$(getent passwd "$TARGET_USER" | cut -d: -f6)
else
  TARGET_UID=911
  TARGET_GID=911
  TARGET_HOME="$HOME"
fi

NPM_CONFIG_FILE="/config/npm.txt"
if [ -f "$NPM_CONFIG_FILE" ]; then
  FILE_NPM_PACKAGES=$(parse_config_file "$NPM_CONFIG_FILE")
  NPM_PACKAGES_TO_INSTALL="$NPM_PACKAGES_TO_INSTALL $FILE_NPM_PACKAGES"
fi

if [ -z "$NPM_PACKAGES_TO_INSTALL" ]; then
  echo "No NPM_PACKAGES configured; skipping."
  exit 0
fi

install_nodejs_dev_environment
wait_for_npm_installer || exit 0
install_nvm "$TARGET_HOME"

NPM_PACKAGES_TO_INSTALL=$(printf "%s" "$NPM_PACKAGES_TO_INSTALL" | tr ',\n\r\t' '    ' | xargs)
echo "Installing npm packages: $NPM_PACKAGES_TO_INSTALL"

run_as_root chown -R "$TARGET_UID:$TARGET_GID" "$TARGET_HOME/.nvm" "$TARGET_HOME/.npm" 2>/dev/null || \
  echo "warn: unable to chown $TARGET_HOME/.nvm or $TARGET_HOME/.npm (continuing)" >&2

export NVM_DIR="$TARGET_HOME/.nvm"
if [ -s "$NVM_DIR/nvm.sh" ]; then
  source "$NVM_DIR/nvm.sh"
fi

if ! command -v npm >/dev/null 2>&1; then
  NPM_BIN=$(find "$NVM_DIR/versions/node" -maxdepth 8 -type f -name npm 2>/dev/null | head -1 || true)
  if [ -n "${NPM_BIN:-}" ]; then
    NODE_DIR=$(dirname "$(dirname "$NPM_BIN")")
    export PATH="$NODE_DIR/bin:$PATH"
    export NPM_CONFIG_PREFIX="$NODE_DIR"
  fi
fi

if ! command -v npm >/dev/null 2>&1; then
  echo "⚠️  npm not found; skipping npm installs."
  exit 0
fi

if [ -n "$NVM_DIR" ] && [ -d "$NVM_DIR/versions/node" ]; then
  NODE_VERSION=$(basename "$(find "$NVM_DIR/versions/node" -maxdepth 1 -type d ! -name node | head -1)" 2>/dev/null || echo "")
  if [ -n "$NODE_VERSION" ]; then
    export NPM_CONFIG_PREFIX="$NVM_DIR/versions/node/$NODE_VERSION"
  fi
fi


for pkg in $NPM_PACKAGES_TO_INSTALL; do
  if run_as_user npm list -g "$pkg" >/dev/null 2>&1; then
    echo "$pkg is already installed, skipping..."
  else
    echo "npm install -g $pkg"
    if ! run_as_user npm install -g "$pkg"; then
      echo "⚠️  warn: failed to install $pkg (continuing)" >&2
    fi
  fi
done

#!/usr/bin/with-contenv bash
# shellcheck shell=bash
set -euo pipefail

source /etc/s6-overlay/s6-rc.d/echo_module.sh
set_module_name "init-devcoder-golang"

echo "▶️  Start installer"

if [ "${GOLANG_INSTALL:-false}" != "true" ] && [ "${GOLANG_INSTALL:-false}" != "True" ] && [ "${GOLANG_INSTALL:-false}" != "1" ]; then
  echo "GOLANG_INSTALL not enabled; skipping."
  exit 0
fi

run_as_root() {
  if [ "$(id -u)" = "0" ]; then
    "$@"
    return
  fi
  if command -v sudo >/dev/null 2>&1; then
    sudo -E "$@"
    return
  fi
  if command -v su >/dev/null 2>&1; then
    su -s /bin/bash root -c "$(printf '%q ' "$@")"
    return
  fi
  "$@"
}

echo "**** ensuring golang is in PATH ****"
if ! grep -q '/usr/local/go/bin' /var/run/s6/container_environment/PATH; then
  printf ':/usr/local/go/bin' >> /var/run/s6/container_environment/PATH
fi
if ! grep -q '/config/go/bin' /var/run/s6/container_environment/PATH; then
  sed -i '1s|^|/config/go/bin:|' /var/run/s6/container_environment/PATH
fi

ARCH=$(uname -m)
GOLANG_ARCHIVE="/golang/golang_${ARCH}.tar.gz"
if [ -f "$GOLANG_ARCHIVE" ]; then
  echo "**** Installing golang ****"
  run_as_root tar xzf "$GOLANG_ARCHIVE" -C /usr/local
  run_as_root rm -rf /golang

  echo "**** Adding gcc to package install list, to make CGO work ****"
  echo_legacy "gcc" >> /devcoder-apt-golang.txt
else
  echo "**** Golang already installed, skipping ****"
fi

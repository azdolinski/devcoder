#!/usr/bin/with-contenv bash
# shellcheck shell=bash
set -euo pipefail

source /etc/s6-overlay/s6-rc.d/echo_module.sh
set_module_name "init-devcoder-homebrew"

say "▶️  Start Homebrew installer"

# Check if Homebrew installation is enabled
if [ "${INSTALL_HOMEBREW:-false}" != "true" ]; then
  say "◾ INSTALL_HOMEBREW not enabled; skipping."
  exit 0
fi

# Determine target user
TARGET_USER="${CUSTOM_USER:-abc}"
if id "$TARGET_USER" >/dev/null 2>&1; then
  TARGET_UID=$(id -u "$TARGET_USER")
  TARGET_GID=$(id -g "$TARGET_USER")
  TARGET_HOME=$(getent passwd "$TARGET_USER" | cut -d: -f6)
else
  TARGET_UID=911
  TARGET_GID=911
  TARGET_HOME="$HOME"
fi

# Function to run commands as the target user
run_as_user() {
  if [ "$(id -u)" = "$(id -u "$TARGET_USER")" ]; then
    "$@"
    return
  fi
  if command -v sudo >/dev/null 2>&1; then
    /usr/bin/sudo -E -u "$TARGET_USER" env PATH="$PATH" "$@"
    return
  fi
  if command -v s6-setuidgid >/dev/null 2>&1; then
    s6-setuidgid "$TARGET_USER" "$@"
    return
  fi
  su -s /bin/bash "$TARGET_USER" -c "$(printf '%q ' "$@")"
}

# Check if Homebrew is already installed
if [ -d "$TARGET_HOME/.linuxbrew" ]; then
  say "◾ Homebrew already installed at $TARGET_HOME/.linuxbrew; skipping."
  # Still ensure PATH is set up
  if [ -f "$TARGET_HOME/.bashrc" ]; then
    if ! grep -q 'linuxbrew' "$TARGET_HOME/.bashrc" 2>/dev/null; then
      say "**** Adding Homebrew to PATH in .bashrc ****"
      run_as_user bash -c 'echo "eval \"\$(\$HOME/.linuxbrew/bin/brew shellenv)\"" >> "$HOME/.bashrc"'
    fi
  fi
  exit 0
fi

# Install dependencies required by Homebrew
say "**** Installing Homebrew dependencies ****"
echo_legacy "build-essential" >> /devcoder-apt-homebrew.txt
echo_legacy "procps" >> /devcoder-apt-homebrew.txt
echo_legacy "curl" >> /devcoder-apt-homebrew.txt
echo_legacy "file" >> /devcoder-apt-homebrew.txt
echo_legacy "git" >> /devcoder-apt-homebrew.txt

# Wait for dependencies to be installed (max 60 seconds)
say "**** Waiting for dependencies to be installed ****"
waited=0
while ! command -v git >/dev/null 2>&1; do
  if (( waited >= 60 )); then
    say "⚠️  Warning: Dependencies not installed after 60 seconds. Continuing anyway..."
    break
  fi
  sleep 1
  ((waited++)) || true
done

# Install Homebrew non-interactively as non-root user
say "**** Installing Homebrew (non-interactive) ****"
if ! run_as_user bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)" < /dev/null; then
  say "❌ Homebrew installation failed"
  exit 1
fi

# Add Homebrew to PATH in .bashrc
say "**** Adding Homebrew to PATH in .bashrc ****"
if [ -f "$TARGET_HOME/.bashrc" ]; then
  run_as_user bash -c 'echo "eval \"\$(\$HOME/.linuxbrew/bin/brew shellenv)\"" >> "$HOME/.bashrc"'
fi

say "✅ Homebrew installed successfully"
